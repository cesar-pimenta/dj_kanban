{% extends "base.html" %}

{% block title %}Boards{% endblock %}

{% block extra_css %}
<style>
    .board-card .card {
        height: 250px;
        cursor: pointer;
    }

    .board-card .card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn.btn-danger.btn-sm.rounded-circle {
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex">
    <div class="container-fluid mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>Todos os Quadros</h3>
            <div>
                <button id="toggleViewBtn" class="btn btn-outline-secondary">Alternar Visualização</button>
                <button id="createBoardCard" class="btn btn-success">Criar Novo Quadro</button>
            </div>
        </div>
        <div class="row row-cols-1 row-cols-md-3 g-4" id="boardContainer">
            {% for board in boards %}
                <div class="col board-card" data-id="{{ board.id }}">
                    <div class="card h-100" onclick="location.href='{% url 'index' board.id %}'" style="cursor: pointer;">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title">{{ board.name }}</h5>
                            </div>
                            <button class="btn btn-danger btn-sm rounded-circle" onclick="event.stopPropagation(); showDeleteModal({{ board.id }});">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col board-card" id="emptyCard">
                    <div class="card h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <span><b>Não existem boards criados,</b></span>
                                <span>crie um novo board para iniciar o seu Gerenciamento</span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <ul id="boardList" class="list-group d-none">
            {% for board in boards %}
            <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ board.id }}">
                <span onclick="location.href='{% url 'index' board.id %}'" style="cursor: pointer;">{{ board.name }}</span>
                <button class="btn btn-danger btn-sm rounded-circle" onclick="event.stopPropagation(); showDeleteModal({{ board.id }});">
                    <i class="fas fa-times"></i>
                </button>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Modal para criar novos Boards -->
<div class="modal fade" id="newBoardModal" tabindex="-1" aria-labelledby="newBoardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newBoardModalLabel">Criar Novo Quadro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newBoardForm">
                    <div class="mb-3">
                        <label for="boardName" class="form-label">Nome do Quadro</label>
                        <input type="text" class="form-control" id="boardName" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Criar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal para deleta os Boards -->
<div class="modal fade" id="deleteBoardModal" tabindex="-1" aria-labelledby="deleteBoardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBoardModalLabel">Excluir Quadro</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este quadro?</p>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var createBoardCard = document.getElementById('createBoardCard');
        var toggleViewBtn = document.getElementById('toggleViewBtn');
        var boardContainer = document.getElementById('boardContainer');
        var boardList = document.getElementById('boardList');
        var confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        var deleteBoardModal = new bootstrap.Modal(document.getElementById('deleteBoardModal'));
        var boardToDelete = null;

        createBoardCard.addEventListener('click', function () {
            var newBoardModal = new bootstrap.Modal(document.getElementById('newBoardModal'));
            newBoardModal.show();
        });

        toggleViewBtn.addEventListener('click', function () {
            boardContainer.classList.toggle('d-none');
            boardList.classList.toggle('d-none');
            toggleViewBtn.textContent = boardContainer.classList.contains('d-none') ? 'Visualizar como Cards' : 'Visualizar como Lista';
        });

        var newBoardForm = document.getElementById('newBoardForm');
        newBoardForm.addEventListener('submit', function (event) {
            event.preventDefault();
            var boardName = document.getElementById('boardName').value;
            fetch("{% url 'create_board' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({name: boardName})
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    var newBoardCard = `
                        <div class="col board-card" data-id="${data.id}">
                            <div class="card h-100" onclick="location.href='/board/${data.id}/'" style="cursor: pointer;">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">${data.name}</h5>
                                    </div>
                                    <button class="btn btn-danger btn-sm rounded-circle" onclick="event.stopPropagation(); showDeleteModal(${data.id});">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    boardContainer.insertAdjacentHTML('beforeend', newBoardCard);

                    var newBoardItem = `
                        <li class="list-group-item d-flex justify-content-between align-items-center" data-id="${data.id}">
                            <span onclick="location.href='/board/${data.id}/'" style="cursor: pointer;">${data.name}</span>
                            <button class="btn btn-danger btn-sm rounded-circle" onclick="event.stopPropagation(); showDeleteModal(${data.id});">
                                <i class="fas fa-times"></i>
                            </button>
                        </li>
                    `;
                    boardList.insertAdjacentHTML('beforeend', newBoardItem);

                    var emptyCard = document.getElementById('emptyCard');
                    if (emptyCard) {
                        emptyCard.remove();
                    }
                }
            });
            var modal = bootstrap.Modal.getInstance(document.getElementById('newBoardModal'));
            modal.hide();
            newBoardForm.reset();
        });

        window.showDeleteModal = function (boardId) {
            boardToDelete = boardId;
            deleteBoardModal.show();
        };

        confirmDeleteBtn.addEventListener('click', function () {
            fetch(`/delete_board/${boardToDelete}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    var boardCard = document.querySelector(`.board-card[data-id='${boardToDelete}']`);
                    var boardItem = document.querySelector(`li[data-id='${boardToDelete}']`);
                    if (boardCard) {
                        boardCard.remove();
                    }
                    if (boardItem) {
                        boardItem.remove();
                    }
                    deleteBoardModal.hide();

                    if (!document.querySelectorAll('.board-card').length) {
                        var emptyCard = `
                            <div class="col board-card" id="emptyCard">
                                <div class="card h-100">
                                    <div class="card-body d-flex justify-content-between align-items-center">
                                        <div>
                                            <span><b>Não existem boards criados,</b></span>
                                            <span>crie um novo board para iniciar o seu Gerenciamento</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        boardContainer.insertAdjacentHTML('beforeend', emptyCard);
                    }
                }
            });
        });
    });
</script>
{% endblock %}
